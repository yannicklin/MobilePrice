angular.module("MobilePriceCompare.TWOUDIA",["ngAnimate","ui.bootstrap","smart-table","angular.filter","angular-loading-bar"]).run(["$rootScope","$log","$filter",function(t,e,a){t.GridData="",t.drawMAPD3=function(t,e,r,o,n,i,c){n.selectAll("*").remove(),d3.json(r,function(r,l){var d=topojson.feature(l,l.objects.Areas),s=.1,p=.1;for(idx=d.features.length-1;idx>=0;idx--){var u=a("filter")(o,{country_iso:d.features[idx].properties.iso_a3},!0);0==u.length?d.features[idx].properties.baseprice_date=0:(d.features[idx].properties.baseprice_date=Math.round(u[0].baseprice_date),d.features[idx].properties.price=u[0].price,d.features[idx].properties.currency=u[0].currency,d.features[idx].properties.basecurrency=u[0].basecurrency,u[0].baseprice_date<s&&(s=u[0].baseprice_date),u[0].baseprice_date>p&&(p=u[0].baseprice_date))}var f=d3.geo.robinson().scale(1).translate([0,0]),m=d3.geo.path().projection(f),y=m.bounds(d),h=.95/Math.max((y[1][0]-y[0][0])/t,(y[1][1]-y[0][1])/e),g=[(t-h*(y[1][0]+y[0][0]))/2,(e-h*(y[1][1]+y[0][1]))/2];f.scale(h).translate(g),n.selectAll("path").data(d.features).enter().append("path").attr("d",m).attr("id",function(t){return t.properties.sovereignt}).style("stroke-width","1").style("stroke","white").on("click",function(a){a.properties.baseprice_date>0&&(c.html('<div class="text_underline">'+a.properties.name+"</div>Original: "+a.properties.currency+" "+a.properties.price+"<br />Converted: "+a.properties.basecurrency+" "+a.properties.baseprice_date).style("left",parseInt(n.node().getBoundingClientRect().left+window.pageXOffset+t/2-100)+"px").style("top",parseInt(n.node().getBoundingClientRect().top+window.pageYOffset+e/2-30)+"px"),c.transition().duration(500).style("opacity",.9).transition().duration(500).style("opacity",0).delay(4e3))}).on("mouseover",function(t){i.html(t.properties.name).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-28+"px"),i.transition().duration(200).style("opacity",.9)}).on("mouseout",function(t){i.transition().duration(200).style("opacity",0)});var b=d3.scale.linear().domain([s,p]).range(["#FFFFCC","#E6A817"]);n.selectAll("path").data(d.features).attr({d:m,fill:function(t){return 0==t.properties.baseprice_date?"#708090":b(t.properties.baseprice_date)}})})}}]).config([function(){}]).controller("TWCtrl",["$scope","$log",function(t,e){t.copyrightsyear=(new Date).getFullYear()>2016?"2016 - "+(new Date).getFullYear():"2016"}]).controller("MainCtrl",["$scope","$log","$filter","$http",function(t,e,a,r){t.form={},t.tabs=[{title:"Globe",template:"views/globe.html"},{title:"Asia",template:"views/asia.html"},{title:"Europe",template:"views/europe.html"},{title:"Africa",template:"views/africa.html"},{title:"Oceania",template:"views/oceania.html"},{title:"North America",template:"views/northamerica.html"},{title:"South America",template:"views/southamerica.html"}],r.get("recordFetch.php?table=v_product").success(function(e){t.optProductBrand=a("unique")(e,"brand"),t.optProductModelRAW=a("unique")(e,"con_B_M"),t.optProductSPECRAW=e,t.form.selProductBrand=t.optProductModelRAW[0].brand,t.selProductBrandChanged()}),r.get("recordFetch.php?table=v_currency_country").success(function(e){t.optCurrency=e}),t.selProductBrandChanged=function(){t.optProductModel=a("filter")(t.optProductModelRAW,{brand:t.form.selProductBrand},!0),t.form.selProductModel=t.optProductModel[0].model,t.selProductModelChanged()},t.selProductModelChanged=function(){t.optProductSPEC=a("filter")(t.optProductSPECRAW,{brand:t.form.selProductBrand,model:t.form.selProductModel},!0),t.form.selProductSPEC=t.optProductSPEC[0].spec},t.form.inpEXDate=new Date((new Date).setDate((new Date).getDate()-1)),t.inpEXDatePopup={opened:!1},t.inpEXDateOpt={format:"yyyy-MM-dd",maxDate:new Date((new Date).setDate((new Date).getDate()-1)),minDate:new Date((new Date).setDate((new Date).getDate()-90)),startingDay:0,showWeeks:!1},t.inpEXDateClick=function(){t.inpEXDatePopup.opened=!0},t.form.selCurrency="USD",t.selCurrencyChanged=function(){t.GridData&&t.priceEnquiry()},t.$watchCollection("form",function(){t.GridData="";var e=!0;t.form.selProductBrand||(e=!1),t.form.selProductModel||(e=!1),t.form.selProductSPEC||(e=!1),t.form.selCurrency||(e=!1),t.form.inpEXDate||(e=!1),t.condsCompleted=e}),t.priceEnquiry=function(){t.condsCompleted&&(t.GridData="",r.get("recordFetch.php?table=v_pricesummary&cond=y&brand="+encodeURIComponent(t.form.selProductBrand)+"&model="+encodeURIComponent(t.form.selProductModel)+"&spec="+encodeURIComponent(t.form.selProductSPEC)+"&basecurrency="+encodeURIComponent(t.form.selCurrency)+"&ratedate="+encodeURIComponent(a("date")(t.form.inpEXDate,"yyyy-MM-dd"))).success(function(e){t.GridData=e}))}}]).controller("GlobeCtrl",["$scope","$log","$window",function(t,e,a){function r(){var e=parseInt(d3.select("#globemap").style("width"),10),a=.5*e;o.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/worldmap-2016.topo.json",t.twGrid,o,n,i)}var o=d3.select("#globemap").append("svg"),n=d3.select("#globemap").append("div").attr("class","tooltip").style("opacity",0),i=d3.select("#globemap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=t.GridData,r()}),angular.element(a).bind("orientationchange",function(){r()}),angular.element(a).bind("resize",function(){r()})}]).controller("AsiaCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.9*parseInt(d3.select("#asiamap").style("width"),10),a=.7*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/asia-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#asiamap").append("svg"),i=d3.select("#asiamap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#asiamap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"Asia"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("EuropeCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.9*parseInt(d3.select("#europemap").style("width"),10),a=.3*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/europe-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#europemap").append("svg"),i=d3.select("#europemap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#europemap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"Europe"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("AfricaCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.6*parseInt(d3.select("#africamap").style("width"),10),a=1*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/africa-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#africamap").append("svg"),i=d3.select("#africamap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#africamap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"Africa"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("OceaniaCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.7*parseInt(d3.select("#oceaniamap").style("width"),10),a=.8*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/oceania-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#oceaniamap").append("svg"),i=d3.select("#oceaniamap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#oceaniamap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"Oceania"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("NorthAmericaCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.9*parseInt(d3.select("#northamericamap").style("width"),10),a=.6*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/northamerica-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#northamericamap").append("svg"),i=d3.select("#northamericamap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#northamericamap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"North America"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("SouthAmericaCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){var e=.5*parseInt(d3.select("#southamericamap").style("width"),10),a=1.5*e;n.attr("width",e).attr("height",a),t.drawMAPD3(e,a,"geo/southamerica-2016.topo.json",t.twGrid,n,i,c)}var n=d3.select("#southamericamap").append("svg"),i=d3.select("#southamericamap").append("div").attr("class","tooltip").style("opacity",0),c=d3.select("#southamericamap").append("div").attr("class","popover").style("opacity",0);t.$watchCollection("GridData",function(){t.twGrid=a("filter")(t.GridData,{continent:"South America"},!0),o()}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).controller("HistoryCtrl",["$scope","$log","$filter","$http",function(t,e,a,r){t.form={},t.historyEnquiry=function(){t.form.selProductBrand&&(t.GridData="",r.get("recordFetch.php?table=v_history_price&cond=y&brand="+encodeURIComponent(t.form.selProductBrand)).success(function(e){t.GridData=e}))},r.get("recordFetch.php?table=v_product").success(function(e){t.optProductBrand=a("unique")(e,"brand"),t.form.selProductBrand=t.optProductBrand[0].brand,t.historyEnquiry()})}]).controller("TrendCtrl",["$scope","$log","$filter","$http",function(t,e,a,r){t.form={},r.get("recordFetch.php?table=v_product").success(function(e){t.optProductBrand=a("unique")(e,"brand"),t.optProductModelRAW=a("unique")(e,"con_B_M"),t.optProductSPECRAW=e,t.form.selProductBrand=t.optProductModelRAW[0].brand,t.selProductBrandChanged()}),t.selProductBrandChanged=function(){t.optProductModel=a("filter")(t.optProductModelRAW,{brand:t.form.selProductBrand},!0),t.form.selProductModel=t.optProductModel[0].model,t.selProductModelChanged()},t.selProductModelChanged=function(){t.optProductSPEC=a("filter")(t.optProductSPECRAW,{brand:t.form.selProductBrand,model:t.form.selProductModel},!0),t.form.selProductSPEC=t.optProductSPEC[0].spec,t.selProductSPECChanged()},t.selProductSPECChanged=function(){t.optCountry="",r.get("recordFetch.php?table=v_product_availcountry&cond=y&brand="+encodeURIComponent(t.form.selProductBrand)+"&model="+encodeURIComponent(t.form.selProductModel)+"&spec="+encodeURIComponent(t.form.selProductSPEC)).success(function(e){t.optCountry=e,t.form.selCountry=t.optCountry[0].country_iso})},t.optCurrency="",r.get("recordFetch.php?table=v_currency_country").success(function(e){t.optCurrency=e,t.form.selCurrency=t.optCurrency[0].currency}),t.optDateRange=[{value:"30",label:"30 Days"},{value:"60",label:"60 Days"},{value:"90",label:"90 Days"},{value:"120",label:"120 Days"}],t.form.selDateRange=t.optDateRange[0].value,t.$watchCollection("form",function(){t.ChartData="",t.ChartDataDateRange=0;var e=!0;t.form.selProductBrand||(e=!1),t.form.selProductModel||(e=!1),t.form.selProductSPEC||(e=!1),t.form.selCountry||(e=!1),t.form.selCurrency||(e=!1),t.form.selDateRange||(e=!1),t.condsCompleted=e}),t.trendEnquiry=function(){if(t.condsCompleted){t.ChartData="";var e=new Date((new Date).setDate((new Date).getDate()-1-t.form.selDateRange)),o=new Date((new Date).setDate((new Date).getDate()-1));r.get("recordFetch.php?table=v_pricesummary&cond=y&country_iso="+encodeURIComponent(t.form.selCountry)+"&brand="+encodeURIComponent(t.form.selProductBrand)+"&model="+encodeURIComponent(t.form.selProductModel)+"&spec="+encodeURIComponent(t.form.selProductSPEC)+"&basecurrency="+encodeURIComponent(t.form.selCurrency)+"&ratedate>="+encodeURIComponent(a("date")(e,"yyyy-MM-dd"))+"&ratedate<="+encodeURIComponent(a("date")(o,"yyyy-MM-dd"))).success(function(e){t.ChartData=e,t.ChartDataDateRange=t.form.selDateRange})}}}]).controller("ChartCtrl",["$scope","$log","$filter","$window",function(t,e,a,r){function o(){function t(t,e,a,r,i){funcDrawTip=function(t,e,a,r){function n(t){var e=[];return e.push("Date: "+t.tip_date),e.push(r+": "+t[a]),e.filter(function(t,a){return e.indexOf(t)===a})}var i,d,s=5,p=10,u=500,f=d3.select(e),m=parseFloat(f.attr("cx")),y=parseFloat(f.attr("cy")),h=parseFloat(f.attr("r")),g=f.attr("fill"),b=0,w=0,v=0,C=n(t),D=d3.rgb(d3.rgb(g).r+.6*(255-d3.rgb(g).r),d3.rgb(g).g+.6*(255-d3.rgb(g).g),d3.rgb(g).b+.6*(255-d3.rgb(g).b)),P=d3.rgb(d3.rgb(g).r+.8*(255-d3.rgb(g).r),d3.rgb(g).g+.8*(255-d3.rgb(g).g),d3.rgb(g).b+.8*(255-d3.rgb(g).b));null!==l._tooltipGroup&&void 0!==l._tooltipGroup&&l._tooltipGroup.remove(),l._tooltipGroup=l.append("g"),l._tooltipGroup.append("circle").attr("cx",m).attr("cy",y).attr("r",h).call(function(){this.attr("opacity",0).style("fill","none").style("stroke",g).style("stroke-width",1)}).transition().duration(u/2).ease("linear").attr("r",h+4).call(function(){this.attr("opacity",1).style("stroke-width",2)}),l._tooltipGroup.append("line").attr("x1",m).attr("y1",y+h+4).attr("x2",m).attr("y2",y+h+4).call(function(){this.style("fill","none").style("stroke",g).style("stroke-width",2).style("stroke-dasharray","3, 3").style("opacity",.8)}).transition().delay(u/2).duration(u/2).ease("linear").attr("y2",c),l._tooltipGroup.append("line").attr("x1",m-h-4).attr("y1",y).attr("x2",m-h-4).attr("y2",y).call(function(){this.style("fill","none").style("stroke",g).style("stroke-width",2).style("stroke-dasharray","3, 3").style("opacity",.8)}).transition().delay(u/2).duration(u/2).ease("linear").attr("x2",0);var x=l._tooltipGroup.append("g"),$=x.append("rect");x.selectAll(".tipText").data(C).enter().append("text").text(function(t){return t}).classed("tipText",!0),x.each(function(){w=this.getBBox().width>w?this.getBBox().width:w,v=this.getBBox().height>v?this.getBBox().height:v}),x.selectAll("text").attr("x",0).attr("y",function(){return b+=this.getBBox().height,b-this.getBBox().height/2+s}),$.attr("x",-s).attr("y",-s).attr("height",Math.ceil(b+2*s)).attr("width",w+2*s).attr("rx",5).attr("ry",5).call(function(){this.style("fill",D).style("stroke",P).style("stroke-width",2).style("opacity",.8)}),i=m+h+10+2*(s+p)+w<o?m+h+4+p:m-(h+4+(2*s+p)+w),d=y+Math.floor(b/2)+p+s+2<c?y-(Math.floor(b/2)+2):c-p-2*(s+2),x.attr("transform","translate("+i+" , "+d+")")},funcRemoveTip=function(t,e){l._tooltipGroup&&l._tooltipGroup.remove()};var d=d3.svg.line().interpolate("cardinal").x(function(t){return p(t.ratedate)}).y(function(t){return u(t[a])});l.append("path").datum(n).attr({d:d}).style("fill","none").style("stroke",e).style("opacity",.6).style("stroke-width","1px"),l.selectAll(".dot").data(t).enter().append("circle").attr("cy",function(t){return u(t[a])}).attr("cx",function(t){return p(t.ratedate)}).attr("r",r).attr("fill",e).attr("stroke",e).on("mouseover",function(t){funcDrawTip(t,this,a,i)}).on("mouseleave",function(t){funcRemoveTip(t,this)})}i.selectAll("*").remove();var e=.9*parseInt(d3.select("#chart").style("width"),10),a=.5*e,r={top:10,right:20,bottom:50,left:50},o=e-(r.left+r.right),c=a-(r.top+r.bottom),l=i.attr("width",e).attr("height",a).append("g").attr("transform","translate("+r.left+","+r.top+")"),d=.95*d3.min(n,function(t){return t.baseprice_date}),s=1.05*d3.max(n,function(t){return t.baseprice_date}),p=d3.time.scale().domain(d3.extent(n,function(t){return t.ratedate})).range([0,o]),u=d3.scale.linear().domain([d,s]).range([c,0]),f=d3.svg.axis().scale(p).orient("bottom").ticks(10).tickFormat(d3.time.format("%d %b")),m=d3.svg.axis().scale(u).orient("left").ticks(5).tickFormat(function(t){return 1e5<t<1e-5?"$ "+t:"$ "+t.toExponential()}),y=d3.svg.axis().scale(p).orient("bottom").ticks(10).tickSize(-c,0,0).tickFormat(""),h=d3.svg.axis().scale(u).orient("left").ticks(5).tickSize(-o,0,0).tickFormat("");l.append("g").attr({"class":"x axis",transform:"translate(0,"+c+")"}).call(f).append("text").classed("axis-label",!0).attr("x",o).attr("y",-6).style("text-anchor","end").text("Date"),l.append("g").attr({"class":"y axis"}).call(m).append("text").classed("axis-label",!0).attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Converted"),l.append("g").attr({"class":"grid",transform:"translate(0,"+c+")"}).call(y),l.append("g").attr({"class":"y-grid"}).call(h),l.selectAll("g.x.axis").selectAll("text:not(.axis-label)").style("text-anchor","end").attr("transform","rotate(-60)"),l.selectAll("g.y.axis").selectAll("text:not(.axis-label)").style("text-anchor","end").attr("transform","rotate(-45)"),t(n,"#d9534f","baseprice_30days",3,"30days Avg"),t(n,"#428bca","baseprice_date",4,"Price");var g=d3.scale.ordinal().range(["rect-bt-darkblue","rect-bt-red"]),b=l.selectAll(".legend").data(["Price","30 Days Running Average"]).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+20*e+")"});b.append("rect").attr("x",o-18).attr("class",g),b.append("text").attr("x",o-24).attr("y",7).attr("dy",".35em").style("text-anchor","end").text(function(t){return t})}var n,i=d3.select("#chart").append("svg");t.$watchCollection("ChartData",function(){if(t.ChartDataDateRange){for(n=[],idx=0;idx<t.ChartDataDateRange;idx++){var e={},r=new Date((new Date).setDate((new Date).getDate()-1-idx));r=a("date")(r,"yyyy-MM-dd");var i=a("filter")(t.ChartData,{ratedate:r},!0);i.length?(e.ratedate=d3.time.format("%Y-%m-%d").parse(i[0].ratedate),e.tip_date=i[0].ratedate,e.baseprice_date=+(Math.round(i[0].baseprice_date+"e+2")+"e-2"),e.baseprice_30days=+(Math.round(i[0].baseprice_30days+"e+2")+"e-2")):(e.ratedate=d3.time.format("%Y-%m-%d").parse(r),e.tip_date=r,e.baseprice_date=0,e.baseprice_30days=0),n.push(e)}o()}}),angular.element(r).bind("orientationchange",function(){o()}),angular.element(r).bind("resize",function(){o()})}]).directive("stRatio",function(){return{link:function(t,e,a){var r=+a.stRatio;e.css("width",r+"%")}}});